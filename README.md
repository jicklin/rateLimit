# Redisé™æµç³»ç»Ÿ

åŸºäºRediså’Œä»¤ç‰Œæ¡¶ç®—æ³•çš„åˆ†å¸ƒå¼é™æµç³»ç»Ÿï¼Œæ”¯æŒIPã€ç”¨æˆ·IDã€è·¯å¾„ç­‰å¤šç»´åº¦é™æµï¼Œæä¾›å®Œæ•´çš„ç®¡ç†ç•Œé¢å’Œç»Ÿè®¡åŠŸèƒ½ã€‚

## åŠŸèƒ½ç‰¹æ€§

### ğŸš€ æ ¸å¿ƒåŠŸèƒ½
- **å¤šç»´åº¦é™æµ**: é»˜è®¤åŸºäºè·¯å¾„é™æµï¼Œå¯é€‰æ‹©å¯ç”¨IPå’Œç”¨æˆ·IDç»´åº¦
- **å¤šé‡æ ¡éªŒ**: å¯ç”¨å¤šä¸ªç»´åº¦æ—¶ï¼Œè¯·æ±‚éœ€é€šè¿‡æ‰€æœ‰ç»´åº¦çš„é™æµæ£€æŸ¥
- **ä»¤ç‰Œæ¡¶ç®—æ³•**: åŸºäºRedisçš„åˆ†å¸ƒå¼ä»¤ç‰Œæ¡¶å®ç°ï¼Œæ”¯æŒçªå‘æµé‡
- **Antè·¯å¾„åŒ¹é…**: æ”¯æŒ`?`ã€`*`ã€`**`é€šé…ç¬¦çš„è·¯å¾„æ¨¡å¼åŒ¹é…
- **HTTPæ–¹æ³•è¿‡æ»¤**: å¯é€‰æ‹©æ€§åœ°å¯¹ç‰¹å®šHTTPæ–¹æ³•è¿›è¡Œé™æµ
- **è¯¦ç»†æ—¥å¿—è®°å½•**: è®°å½•é™æµé˜»æ­¢çš„è¯¦ç»†ä¿¡æ¯ï¼Œä¾¿äºåˆ†æå’Œç›‘æ§

### ğŸ“Š ç»Ÿè®¡åˆ†æ
- **å®æ—¶ç»Ÿè®¡**: è¯·æ±‚æ•°ã€é˜»æ­¢æ•°ã€é€šè¿‡ç‡ç­‰å®æ—¶ç»Ÿè®¡
- **ç»´åº¦ç»Ÿè®¡**: IPå’Œç”¨æˆ·çº§åˆ«çš„è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯
- **å›¾è¡¨å±•ç¤º**: è¯·æ±‚è¶‹åŠ¿å›¾å’Œç»Ÿè®¡å›¾è¡¨
- **æ•°æ®å¯¼å‡º**: æ”¯æŒCSVæ ¼å¼æ•°æ®å¯¼å‡º

### ğŸ›ï¸ ç®¡ç†ç•Œé¢
- **è§„åˆ™ç®¡ç†**: å¯è§†åŒ–çš„é™æµè§„åˆ™é…ç½®å’Œç®¡ç†
- **å®æ—¶ç›‘æ§**: é™æµçŠ¶æ€å’Œç»Ÿè®¡ä¿¡æ¯çš„å®æ—¶ç›‘æ§
- **æµ‹è¯•å·¥å…·**: å†…ç½®çš„é™æµåŠŸèƒ½æµ‹è¯•å·¥å…·
- **å“åº”å¼è®¾è®¡**: æ”¯æŒPCå’Œç§»åŠ¨ç«¯è®¿é—®

## æŠ€æœ¯æ¶æ„

### åç«¯æŠ€æœ¯æ ˆ
- **Spring Boot 2.6.13**: åº”ç”¨æ¡†æ¶
- **Redis**: åˆ†å¸ƒå¼ç¼“å­˜å’Œé™æµçŠ¶æ€å­˜å‚¨
- **Freemarker**: æ¨¡æ¿å¼•æ“
- **Jackson**: JSONåºåˆ—åŒ–
- **Luaè„šæœ¬**: åŸå­æ€§çš„ä»¤ç‰Œæ¡¶æ“ä½œ

### å‰ç«¯æŠ€æœ¯æ ˆ
- **HTML5 + CSS3**: å“åº”å¼ç•Œé¢
- **JavaScript (ES6)**: äº¤äº’é€»è¾‘
- **Axios**: HTTPå®¢æˆ·ç«¯
- **Chart.js**: å›¾è¡¨å±•ç¤º

## å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒè¦æ±‚
- Java 8+
- Redis 3.0+
- Maven 3.6+

### 2. å¯åŠ¨Redis
```bash
redis-server
```

### 3. é…ç½®åº”ç”¨
ç¼–è¾‘ `src/main/resources/application.properties`:
```properties
# Redisé…ç½®
spring.redis.host=localhost
spring.redis.port=6379
spring.redis.database=0

# åº”ç”¨ç«¯å£
server.port=8080
```

### 4. å¯åŠ¨åº”ç”¨
```bash
mvn spring-boot:run
```

### 5. è®¿é—®ç®¡ç†ç•Œé¢
- ç®¡ç†é¦–é¡µ: http://localhost:8080/ratelimit/
- è§„åˆ™é…ç½®: http://localhost:8080/ratelimit/config
- ç»Ÿè®¡åˆ†æ: http://localhost:8080/ratelimit/stats
- åŠŸèƒ½æµ‹è¯•: http://localhost:8080/test.html

## ä½¿ç”¨æŒ‡å—

### åˆ›å»ºé™æµè§„åˆ™

1. **åŸºæœ¬é…ç½®**
   - è§„åˆ™åç§°: ä¾¿äºè¯†åˆ«çš„è§„åˆ™åç§°
   - è·¯å¾„æ¨¡å¼: æ”¯æŒAnté£æ ¼é€šé…ç¬¦
     - `?`: åŒ¹é…å•ä¸ªå­—ç¬¦
     - `*`: åŒ¹é…ä»»æ„å­—ç¬¦ï¼ˆé™¤è·¯å¾„åˆ†éš”ç¬¦ï¼‰
     - `**`: åŒ¹é…ä»»æ„è·¯å¾„
   - HTTPæ–¹æ³•: å¯é€‰æ‹©ç‰¹å®šçš„HTTPæ–¹æ³•

2. **é™æµç»´åº¦**
   - **è·¯å¾„é™æµ**: é»˜è®¤å¯ç”¨ï¼ŒåŸºäºè¯·æ±‚è·¯å¾„è¿›è¡Œé™æµ
   - **IPç»´åº¦é™æµ**: å¯é€‰å¯ç”¨ï¼Œå¯¹æ¯ä¸ªIPåœ°å€å•ç‹¬é™æµ
   - **ç”¨æˆ·ç»´åº¦é™æµ**: å¯é€‰å¯ç”¨ï¼Œå¯¹æ¯ä¸ªç”¨æˆ·IDå•ç‹¬é™æµ
   - **å¤šç»´åº¦æ ¡éªŒ**: å¯ç”¨å¤šä¸ªç»´åº¦æ—¶ï¼Œè¯·æ±‚éœ€è¦é€šè¿‡æ‰€æœ‰ç»´åº¦çš„æ£€æŸ¥

3. **ä»¤ç‰Œæ¡¶é…ç½®**
   - **ä»¤ç‰Œæ¡¶å®¹é‡**: æœ€å¤§ä»¤ç‰Œæ•°ï¼Œå†³å®šçªå‘è¯·æ±‚å¤„ç†èƒ½åŠ›
   - **ä»¤ç‰Œè¡¥å……é€Ÿç‡**: æ¯ç§’è¡¥å……çš„ä»¤ç‰Œæ•°ï¼Œå†³å®šå¹³å‡é™æµé€Ÿç‡
   - **æ—¶é—´çª—å£**: ä»¤ç‰Œè¡¥å……çš„æ—¶é—´é—´éš”

4. **ç»´åº¦é™æµé…ç½®**
   - **IPç»´åº¦é™æµ**: å¯å•ç‹¬é…ç½®æ¯ä¸ªIPçš„é™æµå‚æ•°
   - **ç”¨æˆ·ç»´åº¦é™æµ**: å¯å•ç‹¬é…ç½®æ¯ä¸ªç”¨æˆ·çš„é™æµå‚æ•°

### é…ç½®ç¤ºä¾‹

#### ç¤ºä¾‹1: APIæ¥å£é™æµ
```
è§„åˆ™åç§°: APIæ¥å£é™æµ
è·¯å¾„æ¨¡å¼: /api/**
HTTPæ–¹æ³•: GET, POST
é™æµç±»å‹: IPé™æµ
ä»¤ç‰Œæ¡¶å®¹é‡: 20
ä»¤ç‰Œè¡¥å……é€Ÿç‡: 10
æ—¶é—´çª—å£: 1ç§’
å¯ç”¨IPç»´åº¦é™æµ: æ˜¯
IPè¯·æ±‚é™åˆ¶: 10
```

#### ç¤ºä¾‹2: ç”¨æˆ·æ“ä½œé™æµ
```
è§„åˆ™åç§°: ç”¨æˆ·æ“ä½œé™æµ
è·¯å¾„æ¨¡å¼: /user/*/action
HTTPæ–¹æ³•: POST
é™æµç±»å‹: ç”¨æˆ·é™æµ
ä»¤ç‰Œæ¡¶å®¹é‡: 5
ä»¤ç‰Œè¡¥å……é€Ÿç‡: 2
æ—¶é—´çª—å£: 1ç§’
å¯ç”¨ç”¨æˆ·ç»´åº¦é™æµ: æ˜¯
ç”¨æˆ·è¯·æ±‚é™åˆ¶: 2
```

#### ç¤ºä¾‹3: é«˜é¢‘æ¥å£é™æµ
```
è§„åˆ™åç§°: é«˜é¢‘æ¥å£é™æµ
è·¯å¾„æ¨¡å¼: /high-frequency
HTTPæ–¹æ³•: å…¨éƒ¨
é™æµç±»å‹: è·¯å¾„é™æµ
ä»¤ç‰Œæ¡¶å®¹é‡: 100
ä»¤ç‰Œè¡¥å……é€Ÿç‡: 50
æ—¶é—´çª—å£: 1ç§’
```

## ä»¤ç‰Œæ¡¶ç®—æ³•è¯¦è§£

### ç®—æ³•åŸç†
ä»¤ç‰Œæ¡¶ç®—æ³•é€šè¿‡æ§åˆ¶ä»¤ç‰Œçš„ç”Ÿæˆå’Œæ¶ˆè´¹æ¥å®ç°é™æµï¼š

1. **ä»¤ç‰Œç”Ÿæˆ**: æŒ‰å›ºå®šé€Ÿç‡å‘æ¡¶ä¸­æ·»åŠ ä»¤ç‰Œ
2. **ä»¤ç‰Œæ¶ˆè´¹**: æ¯ä¸ªè¯·æ±‚æ¶ˆè´¹ä¸€ä¸ªä»¤ç‰Œ
3. **æ¡¶å®¹é‡é™åˆ¶**: æ¡¶ä¸­ä»¤ç‰Œæ•°ä¸è¶…è¿‡æœ€å¤§å®¹é‡
4. **è¯·æ±‚å¤„ç†**: æœ‰ä»¤ç‰Œåˆ™å…è®¸è¯·æ±‚ï¼Œæ— ä»¤ç‰Œåˆ™æ‹’ç»

### ä¼˜åŠ¿ç‰¹ç‚¹
- **å¹³æ»‘é™æµ**: å…è®¸çªå‘æµé‡ï¼Œä½†é•¿æœŸå¹³å‡é€Ÿç‡å—é™
- **çµæ´»é…ç½®**: å¯ç‹¬ç«‹é…ç½®æ¡¶å®¹é‡å’Œè¡¥å……é€Ÿç‡
- **åˆ†å¸ƒå¼æ”¯æŒ**: åŸºäºRediså®ç°åˆ†å¸ƒå¼ä¸€è‡´æ€§
- **é«˜æ€§èƒ½**: Luaè„šæœ¬ä¿è¯åŸå­æ€§æ“ä½œ

### Luaè„šæœ¬å®ç°
```lua
-- è·å–å½“å‰ä»¤ç‰Œæ•°å’Œæœ€åè¡¥å……æ—¶é—´
local bucket = redis.call('HMGET', key, 'tokens', 'last_refill')
local current_tokens = tonumber(bucket[1]) or capacity
local last_refill = tonumber(bucket[2]) or now

-- è®¡ç®—éœ€è¦è¡¥å……çš„ä»¤ç‰Œæ•°
local elapsed = math.max(0, now - last_refill)
local tokens_to_add = math.floor(elapsed / interval * tokens)
current_tokens = math.min(capacity, current_tokens + tokens_to_add)

-- åˆ¤æ–­æ˜¯å¦å…è®¸è¯·æ±‚
local allowed = 0
if current_tokens >= requested then
    current_tokens = current_tokens - requested
    allowed = 1
end

-- æ›´æ–°ä»¤ç‰Œæ¡¶çŠ¶æ€
redis.call('HMSET', key, 'tokens', current_tokens, 'last_refill', now)
return {allowed, current_tokens}
```

## APIæ¥å£

### è§„åˆ™ç®¡ç†
- `GET /ratelimit/api/rules` - è·å–æ‰€æœ‰è§„åˆ™
- `GET /ratelimit/api/rules/{id}` - è·å–å•ä¸ªè§„åˆ™
- `POST /ratelimit/api/rules` - åˆ›å»º/æ›´æ–°è§„åˆ™
- `DELETE /ratelimit/api/rules/{id}` - åˆ é™¤è§„åˆ™
- `PUT /ratelimit/api/rules/{id}/toggle` - å¯ç”¨/ç¦ç”¨è§„åˆ™

### ç»Ÿè®¡ä¿¡æ¯
- `GET /ratelimit/api/stats` - è·å–æ‰€æœ‰ç»Ÿè®¡
- `GET /ratelimit/api/stats/global` - è·å–å…¨å±€ç»Ÿè®¡
- `GET /ratelimit/api/stats/{ruleId}/detailed` - è·å–è¯¦ç»†ç»Ÿè®¡
- `GET /ratelimit/api/stats/{ruleId}/ip` - è·å–IPç»Ÿè®¡
- `GET /ratelimit/api/stats/{ruleId}/user` - è·å–ç”¨æˆ·ç»Ÿè®¡

### ç³»ç»Ÿç®¡ç†
- `DELETE /ratelimit/api/stats` - é‡ç½®æ‰€æœ‰ç»Ÿè®¡
- `DELETE /ratelimit/api/reset` - é‡ç½®é™æµçŠ¶æ€

## æµ‹è¯•éªŒè¯

### å†…ç½®æµ‹è¯•å·¥å…·
è®¿é—® http://localhost:8080/test.html ä½¿ç”¨å†…ç½®æµ‹è¯•å·¥å…·ï¼š

1. **å•ä¸ªè¯·æ±‚æµ‹è¯•**: å‘é€å•ä¸ªè¯·æ±‚éªŒè¯é™æµæ•ˆæœ
2. **æ‰¹é‡è¯·æ±‚æµ‹è¯•**: æŒ‰é—´éš”å‘é€å¤šä¸ªè¯·æ±‚
3. **å¹¶å‘è¯·æ±‚æµ‹è¯•**: åŒæ—¶å‘é€å¤šä¸ªè¯·æ±‚
4. **åœºæ™¯æµ‹è¯•**: é¢„è®¾çš„æµ‹è¯•åœºæ™¯
   - æ­£å¸¸è®¿é—®æµ‹è¯•
   - çªå‘æµé‡æµ‹è¯•
   - æ”»å‡»æ¨¡æ‹Ÿæµ‹è¯•
   - å¤šç”¨æˆ·æµ‹è¯•

### æµ‹è¯•æ¥å£
ç³»ç»Ÿæä¾›äº†å¤šä¸ªæµ‹è¯•æ¥å£ï¼š
- `GET /test/get` - GETè¯·æ±‚æµ‹è¯•
- `POST /test/post` - POSTè¯·æ±‚æµ‹è¯•
- `GET /test/api/data` - APIæ¥å£æµ‹è¯•
- `GET /test/user/{userId}` - ç”¨æˆ·æ¥å£æµ‹è¯•
- `GET /test/high-frequency` - é«˜é¢‘æ¥å£æµ‹è¯•

## ç›‘æ§å’Œè¿ç»´

### ç»Ÿè®¡æŒ‡æ ‡
- **è¯·æ±‚æ€»æ•°**: ç³»ç»Ÿå¤„ç†çš„æ€»è¯·æ±‚æ•°
- **å…è®¸è¯·æ±‚æ•°**: é€šè¿‡é™æµæ£€æŸ¥çš„è¯·æ±‚æ•°
- **é˜»æ­¢è¯·æ±‚æ•°**: è¢«é™æµé˜»æ­¢çš„è¯·æ±‚æ•°
- **é˜»æ­¢ç‡**: è¢«é˜»æ­¢è¯·æ±‚çš„ç™¾åˆ†æ¯”
- **è¯·æ±‚é¢‘ç‡**: æ¯ç§’è¯·æ±‚æ•°

### ç»´åº¦ç»Ÿè®¡
- **IPç»Ÿè®¡**: æ¯ä¸ªIPçš„è¯·æ±‚ç»Ÿè®¡
- **ç”¨æˆ·ç»Ÿè®¡**: æ¯ä¸ªç”¨æˆ·çš„è¯·æ±‚ç»Ÿè®¡
- **è§„åˆ™ç»Ÿè®¡**: æ¯ä¸ªè§„åˆ™çš„æ‰§è¡Œç»Ÿè®¡

### æ•°æ®å¯¼å‡º
æ”¯æŒå°†ç»Ÿè®¡æ•°æ®å¯¼å‡ºä¸ºCSVæ ¼å¼ï¼Œä¾¿äºè¿›ä¸€æ­¥åˆ†æã€‚

## æ‰©å±•å¼€å‘

### æ·»åŠ æ–°çš„é™æµç­–ç•¥
1. å®ç° `RateLimitStrategy` æ¥å£
2. æ·»åŠ  `@Component` æ³¨è§£
3. å®ç°å¿…è¦çš„æ–¹æ³•ï¼š
   - `generateKey()`: ç”Ÿæˆé™æµé”®
   - `getRequestLimit()`: è·å–è¯·æ±‚é™åˆ¶
   - `supports()`: æ£€æŸ¥æ˜¯å¦æ”¯æŒ
   - `extractIdentifier()`: æå–æ ‡è¯†ç¬¦

### è‡ªå®šä¹‰ç»Ÿè®¡ç»´åº¦
1. æ‰©å±• `DetailedRateLimitStats` æ¨¡å‹
2. ä¿®æ”¹ `RedisRateLimitStatsService` å®ç°
3. æ›´æ–°å‰ç«¯å±•ç¤ºé€»è¾‘

## æ³¨æ„äº‹é¡¹

1. **Redisè¿æ¥**: ç¡®ä¿RedisæœåŠ¡æ­£å¸¸è¿è¡Œä¸”è¿æ¥é…ç½®æ­£ç¡®
2. **æ—¶é’ŸåŒæ­¥**: åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ç¡®ä¿å„èŠ‚ç‚¹æ—¶é’ŸåŒæ­¥
3. **å†…å­˜ä½¿ç”¨**: ç›‘æ§Rediså†…å­˜ä½¿ç”¨ï¼ŒåŠæ—¶æ¸…ç†è¿‡æœŸæ•°æ®
4. **æ€§èƒ½è°ƒä¼˜**: æ ¹æ®å®é™…è´Ÿè½½è°ƒæ•´ä»¤ç‰Œæ¡¶å‚æ•°
5. **è§„åˆ™ä¼˜å…ˆçº§**: æ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼Œåˆç†è®¾ç½®è§„åˆ™ä¼˜å…ˆçº§

## è®¸å¯è¯

MIT License

## è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestæ¥æ”¹è¿›è¿™ä¸ªé¡¹ç›®ã€‚
